# VPC(Virtual Private Cloud)


![](https://i.imgur.com/6HySO3B.png)

- 독립적인 가상의 네트워크 공간으로, 사용자의 설정에 따라 AWS 리소스를 이용해 자유롭게 구성할 수 있음
- VPC에는 리전의 각 가용 영역에 1개의 서브넷이 있고, 각 서브넷에 EC2 인스턴스가 있고 VPC의 리소스와 인터넷 간의 통신을 허용하는 인터넷 게이트웨이가 있음


### 📌 VPC를 구성하기 위한 기능
---
- VPC (Virtual Private Cloud)
	\- 자체 데이터 센터에서 운영하는 기존 네트워크와 유사한 가상 네트워크
	\- VPC 생성 후 서브넷 추가 가능
- 서브넷
	\- VPC의 IP 주소 범위
	\- 단일 가용 영역에 상주해야하며, 서브넷을 추가한 후 VPC에 AWS 리소스를 배포할 수 있음
- IP 주소 지정
	\-  VPC와 서브넷에 IPv4, IPv6 모두 할당 가능
	\- 퍼블릭 IPv4주소 및 GUA 주소를 AWS로 가져오고 VPC의 리소스`(ex. EC2 인스턴스, NAT 게이트웨이, Network Load Balancer)`에 할당 가능
- 라우팅
	\- 라우팅 테이블을 이용해 서브넷 또는 게이트웨이의 네트워크 트래픽이 전달되는 위치 결정
- 게이트웨이 및 엔드포인트
	\- 게이트웨이 : VPC를 다른 네트워크에 연결
	\- VPC 엔드포인트: 인터넷 게이트웨이 또는 NAT 장치를 사용하지 않고 AWS 서비스에 비공개로 연결
- 피어링 연결
	\- 두 VPC의 리소스 간 트래픽을 라우팅
- 트래픽 미러링
	\- 네트워크 인터페이스에서 네트워크 트래픽을 복사하고 심층 패킷 검사를 위해 보안 및 모니터링 어플라이언스로 전송
- Transit Gateway
	\- 중앙 허브 역할을 하는 전송 게이트웨이를 사용하여 VPC, VPN 연결 및 AWS Direct Connect 연결 간에 트래픽을 라우팅
- VPC 흐름 로그
	\- VPC의 네트워크 인터페이스로 들어오고 나가는 IP 트래픽에 대한 정보를 캡처
- VPN 연결
	\- AWS VPN을 사용해 온프레미스 네트워크에 VPC를 연결


### 📌 VPC 작동 방식
---
  ![](https://i.imgur.com/ZHA1nsF.png)
`VPC 리소스맵 - VPC 내 리소스 간의 관계와 서브넷에서 NAT 게이트웨이, 인터넷 게이트웨이 및 게이트웨이 엔드포인트로 트래픽이 흐르는 방식을 보여줌` 

##### 🏷️ 리소스 목록
- VPC
- 서브넷 (Subnet)
	\- 가용 영역은 문자로 표시
	\- 퍼블릿 서브넷 - 녹색
	\- 프라이빗 서브넷 - 파란색
	\- 라우팅 테이블 (Route Table)
- 인터넷 게이트웨이 (Internet Gateway)
- 외부 전용 인터넷 게이트웨이 (Egress only internet gateway)
-  NAT 게이트웨이
-  게이트웨이 엔드포인트 - `Amazon S3 및 Amazon DynamoDB`

##### 🏷️ 리소스 맵에서 표시되는 세부 정보
- VPC : IPv4 및 IPv6 CIDR 범위
- 서브넷 : IPv4 및 IPv6 CIDR 범위
- 라우팅 테이블 : 서브넷 연결 및 경로 수
- 네트워크 연결
	1. VPC에 퍼블릭 서브넷이 있는 경우 :
		\- 인터넷 게이트웨이를 사용하는 트래픽의 소스 및 대상 서브넷과 경로 수가 포함된 인터넷 게이트웨이 리소스
	2.  외부 전용 인터넷 게이트웨이가 있는 경우 :
		\- 외부 전용 인터넷 게이트웨이를 사용하는 트래픽의 소스 및 대상 서브넷과 경로 수가 포함된 외부 전용 인터넷 게이트웨이 리소스
	3. NAT 게이트웨이가 있는 경우 :
		\- NAT 게이트웨이의 탄력적 IP 주소와 네트워크 인터페이스 수가 포함된 NAT 게이트웨이 리소스
	4. 게이트웨이 엔드포인트가 있는 경우 : 
		\- 엔드포인트를 사용하여 연결할 수 있는 AWS 서비스(Amazon S3 또는 Amazon DynamoDB)의 이름이 포함된 게이트웨이 엔드포인트 리소스

### 📌 서브넷(Subnet)
---
- VPC 내에서 IP 주소 범위를 분할하여 논리적으로 구분한 네트워크 구역
- 서브넷을 사용해 VPC 내의 자원을 분리하고 관리할 수 있으며, 퍼블릭 서브넷과 프라이빗 서브넷으로 구분하여 보안과 트래픽 관리를 효율적으로 할 수 있음

- 서브넷 구성 시 고려 사항
	1) CIDR 블록 : VPC와 서브넷의 CIDR 블록을 적절하게 설정하여 IP 주소 충돌 방지
	2) 가용 영역 : 서브넷을 여러 가용 영역(AZ)에 분산 배치하여 고가용성 확보
	3) 보안 그룹 및 네트워크 ACL : 각 서브넷에 대해 적절한 보안 그룹과 네트워크 ACL을 구성하여 트래픽 제어
	4) 라우팅 테이블 : 퍼블릭 서브넷과 프라이빗 서브넷의 라우팅 테이블을 적절히 구성하여 원하는 트래픽 흐름 설정

##### 🏷️ 퍼블릭 서브넷(Public Subnet)
 \- 인터넷 게이트웨이와 연결된 서브넷
 \- 외부 인터넷과 직접 통신 가능
 \- 주로 웹 서버와 같이 외부에서 접근이 필요한 리소스 배치

##### 🏷️ 프라이빗 서브넷(Private Subnet)
 \- NAT 게이트웨이를 통해서만 인터넷과 통신할 수 있는 서브넷
 \- 외부 인터넷과 직접 통신 불가
 \- 주로 데이터베이스 서버와 같이 외부 접근이 불필요한 리소스 배치

### 📌 라우팅 테이블
---
- VPC 내의 네트워크 트래픽이 올바른 대상 네트워크로 전달되도록 관리하는 설정
- 라우팅 테이블은 하나 이상의 라우팅 규칙을 포함하며, 각 규칙은 특정 대상 CIDR 블록과 해당 트래픽을 전달할 대상(게이트웨이, 인스턴스, 네트워크 인터페이스 등)을 정의함
	`CIDR(Classless Inter-Domain Routing) : 인터넷 상의 데이터 라우팅 효율성을 향상시키는 IP 주소 할당 방법, 빗금 표기법(slash notation)이라 불림`
	`ex) 172.17.0.0/16 => 172.17.0.0 ~ 172.17.255.255의 총 65,536(2의 16승)개의 주소 포함`

##### 🏷️ 주요 개념
1. 라우팅 테이블 (Route Table)
	\- VPC 내에서 네트워크 트래픽이 전달되는 경로를 정의하는 규칙 세트
	\- 각 서브넷은 라우팅 테이블과 연결되어 있으며, 이 테이블을 통해 서브넷의 트래픽이 라우팅됨
2. 라우팅 규칙 (Routes)
	\- 라우팅 테이블 내의 각 규칙은 특정 목적지 CIDR 블록과 해당 트래픽의 대상 `ex) 인터넷 게이트웨이, NAT 게이트웨이, VPC 피어링 연결`을 정의
3. 메인 라우팅 테이블 (Main Route Table)
	\- VPC 생성시 자동으로 생성되는 기본 라우팅 테이블
	\- 서브넷 생성시 라우팅 테이블을 명시하지 않을 경우 자동으로 메인 라우팅 테이블이 연결됨
4. 커스텀 라우팅 테이블 (Custom Route Table)
	\- 사용자가 정의한 라우팅 테이블
	\- 특정 서브넷과 명시적으로 연결

##### 🏷️ 주요 구성 요소
- 목적지 (Destination)
	트래픽의 목적지 CIDR 블록 `ex) 0.0.0.0/0은 모든 IPv4 트래픽을 의미`
- 대상 (Target)
	트래픽을 전달할 대상 `ex) 인터넷 게이트웨이, NAT 게이트웨이, VPC 엔드포인트`

``` ad-note
title: 라우팅 테이블 구성 예시
color: 255, 255, 255
collapse: close

1. 인터넷 연결을 위한 퍼블릭 서브넷 라우팅 테이블
	- 퍼블릭 서브넷의 경우, 인터넷에 접근하기위해 인터넷 게이트웨이 사용
	- 라우팅 규칙
		- 목적지 : 0.0.0.0/0 (모든 IPv4 트래픽)
		- 대상: 인터넷 게이트웨이 (igw-xxxxxxxx)

2. 인터넷 연결을 위한 프라이빗 서브넷 라우팅 테이블
	- 프라이빗 서브넷의 경우, 아웃바운드 인터넷 트래픽을 위해 NAT 게이트웨이 사용
	- 라우팅 규칙
		- 목적지 : 0.0.0.0/0 (모든 IPv4 트래픽)
		- 대상 : NAT 게이트웨이 (nat-xxxxxxxx)

3. VPC 피어링 연결을 위한 라우팅 테이블
	- 다른 VPC와 연결된 서브넷의 경우, VPC 피어링 연결을 통해 트래픽 전달
	- 라우팅 규칙
		- 목적지 : 피어 VPC의 CIDR 블록 `ex) 192.168.0.0/16`
		- 대상 : VPC 피어링 연결 (pcx-xxxxxxxx)
```


### 📌 NAT 게이트웨이 (Network Address Translation Gateway)
---
- 프라이빗 서브넷의 인스턴스가 인터넷이나 다른 AWS 서비스에 접근할 수 있도록 하는 서비스
- 프라이빗 서브넷의 인스턴스는 직접적으로 인터넷에 접근할 수 없지만, NAT 게이트웨이를 통해서 간접적으로 접근 가능 
	`NAT 게이트웨이를 퍼블릭 서브넷에 생성해야 퍼블릭 IP(Elastic IP)를 통해 인터넷에 접근할 수 있음`
		=> 이를 통해 프라이빗 서브넷의 인스턴스는 인터넷과 통신이 가능하지만,
		 외부에서 이 인스턴스에 접근하는것은 불가능
	
##### 🏷️ 주요 기능
1. 인터넷 접근 허용
	\- 프라이빗 서브넷의 인스턴스가 인터넷에 접근할 수 있게 해줌
	\- 주로 소프트웨어 업데이트, 패치 적용, 외부 API 호출 등에 사용
2. 보안 강화
	\- 인스턴스가 인터넷에 직접적으로 노출되지 않도록 하여 보안 강화
3. 고가용성
	\- AWS 관리형 서비스로, 높은 가용성을 제공

##### 🏷️ 구성 요소
- Elastic IP (EIP) : 퍼블릭 서브넷의 NAT 게이트웨이에 할당된 고정 퍼블릭 IP 주소
- 프라이빗 서브넷 : NAT 게이트웨이를 통해 인터넷에 접근할 인스턴스가 위한 서브넷
- 라우팅 테이블 : 프라이빗 서브넷에서 나가는 트래픽을 NAT 게이트웨이로 라우팅하기 위해 설정된 테이블

##### 🏷️ 연결 유형
1. 퍼블릭 `(default)`
	\- 인터넷에 연결할 수 있지만 인터넷에서 원치 않는 인바운드 연결을 수신할 수 없음
	\- 퍼블릭 서브넷에서 퍼블릭 NAT 게이트웨이를 생성하고, 생성시 탄력적 IP 주소를 NAT 게이트웨이와 연결하는 경우 트래픽을 NAT 게이트웨이에서 VPC용 인터넷 게이트웨이로 라우팅 함
	\- 다른 VPC 또는 온프레미스 네트워크에 연결 하는 경우 NAT 게이트웨이 -> Transit Gateway 또는 가상 프라이빗 게이트웨이를 통해 트래픽을 라우팅 함
	
2. 프라이빗
	\- 다른 VPC 또는 온프레미스 네트워크에 연결 가능
	\- NAT 게이트웨이 -> Transit Gateway / 가상 프라이빗 게이트웨이를 통해 트래픽을 라우팅 함
	\- 탄력적 IP주소 연결 불가
	\- VPC에 인터넷 게이트웨이를 연결할 수 있지만 인터넷 게이트웨이로 트래픽을 라우팅 하는 경우 인터넷 게이트웨이가 트래픽을 삭제함

- 두 유형 모두 인스턴스의 소스 프라이빗 IPv4주소를 NAT 게이트웨이의 프라이빗 IPv4 주소에 매핑함
- 인스턴스에 응답 트래픽 전송시 유형에 상관없이 NAT 게이트웨이는 주소를 원래 소스 IP주소로 다시 변환 시킴


### 📌 보안 그룹 (Security Group)
---
![](https://i.imgur.com/Kra0q9I.png)

- VPC에서 EC2 인스턴스와 같은 리소스에 대한 네트워크 트래픽을 제어하는 가상 방화벽 역할
- 인바운드(수신) 및 아웃바운드(발신) 규칙을 정의하여 허용되는 트래픽 유형을 결정

##### 🏷️ 특징
1. 상태 저장(Stateful)
	\- 인바운드 트래픽이 허용되면 해당 트래픽에 대한 응답은 아웃바운드 규칙을 명시하지 않아도 자동으로 허용됨 (반대의 경우도 마찬가지 - `아웃바운드 트래픽 허용시 인바운드 규칙 명시없이도 자동으로 허용`)
2. 기본 허용 정책
	\- 기본적으로 모든 인바운드 트래픽은 차단됨
	\- 기본적으로 모든 아웃바운드 트래픽은 허용됨
3. 인바운드 및 아웃바운드
	\- 특정 IP 주소나 범위, 또는 다른 보안 그룹을 대상으로 트래픽 허용
	\- 프로토콜, 포트 범위 등을 지정하여 세부적인 트래픽 제어 가능

``` ad-info
title: 인바운드(Inbound) 트래픽, 아웃바운드(Outbound) 트래픽
color: 255, 255, 255
collapse: close

- 인바운드(Inbound) 트래픽
	\- 네트워크 외부에서 인스턴스로 들어오는 트래픽
	\- 인바운드 규칙은 어떤 트래픽이 인스턴스로 들어올 수 있는지를 정의함

- 아웃바운드(Outbound) 트래픽
	\- 인스턴스에서 네트워크 외부로 나가는 트래픽
	\- 아웃바운드 규칙은 어떤 트래픽이 인스턴스에서 나갈 수 있는지를 정의함
```